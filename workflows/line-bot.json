{
    "name": "LINE 行程查詢 Bot",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "line-bot",
                "options": {}
            },
            "id": "webhook",
            "name": "Line Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                0,
                0
            ],
            "webhookId": "line-bot"
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "accessToken",
                            "value": "08rtpZLZGYFeIkgeFarEoQJ0vGxf0o5oNwtQZv/YAweBoLbWdwx6AY90BmpExgm2BU77wLq0xlKFk9HW4Lq/tmsmxCnvRrA3FdF+lWzt/Gf5+/fsxtFIgY8YO22dXb31UwHbncFqIjTr48LHBu1GqAdB04t89/1O/w1cDnyilFU="
                        },
                        {
                            "name": "channelSecret",
                            "value": "a0a56c9d2d6dd388ab5e8e193ad0a5e1"
                        }
                    ]
                },
                "options": {}
            },
            "id": "config",
            "name": "Config",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                220,
                0
            ]
        },
        {
            "parameters": {
                "jsCode": "const events = $json.body?.events || [];\nif (events.length === 0) {\n  return []; // No events to process\n}\n\nconst event = events[0];\nconst message = event.message?.text || '';\nconst replyToken = event.replyToken;\nconst userId = event.source?.userId;\n\n// 如果沒有 replyToken 或不是文字訊息，就不處理\nif (!replyToken || event.message?.type !== 'text') {\n    return [];\n}\n\nconst now = DateTime.now().setZone('Asia/Taipei');\nlet timeMin, timeMax, queryType, month, year, day;\n\n// 解析指令 logic (保持原樣，但適配變數)\nif (message.includes('今日') || message.includes('今天') || message === '/today') {\n  queryType = 'today';\n  timeMin = now.startOf('day').toISO();\n  timeMax = now.endOf('day').toISO();\n} else if (message.includes('明天') || message === '/tomorrow') {\n  queryType = 'tomorrow';\n  const tomorrow = now.plus({ days: 1 });\n  timeMin = tomorrow.startOf('day').toISO();\n  timeMax = tomorrow.endOf('day').toISO();\n} else {\n  // 嘗試解析指定日期\n  const dateMatch = message.match(/(\\d{1,2})[\\/-月](\\d{1,2})日?/);\n  if (dateMatch) {\n    month = parseInt(dateMatch[1]);\n    day = parseInt(dateMatch[2]);\n    year = now.year;\n    queryType = 'specificDay';\n    const targetDate = DateTime.fromObject({ year, month, day }, { zone: 'Asia/Taipei' });\n    timeMin = targetDate.startOf('day').toISO();\n    timeMax = targetDate.endOf('day').toISO();\n  } else {\n    // 嘗試解析月份\n    const monthMatch = message.match(/(\\d{1,2})\\s*月?/);\n    if (monthMatch) {\n      month = parseInt(monthMatch[1]);\n      year = now.year;\n      if (month > now.month + 6) {\n        year = now.year - 1;\n      }\n      queryType = 'month';\n      const startOfMonth = DateTime.fromObject({ year, month, day: 1 }, { zone: 'Asia/Taipei' });\n      timeMin = startOfMonth.startOf('month').toISO();\n      timeMax = startOfMonth.endOf('month').toISO();\n    } else {\n      // 預設查詢今天\n      queryType = 'today';\n      timeMin = now.startOf('day').toISO();\n      timeMax = now.endOf('day').toISO();\n    }\n  }\n}\n\nreturn [{\n  json: {\n    queryType,\n    timeMin,\n    timeMax,\n    month: month || now.month,\n    day: day || now.day,\n    year: year || now.year,\n    userId,\n    replyToken\n  }\n}];"
            },
            "id": "parse-command",
            "name": "Parse Command",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                440,
                0
            ]
        },
        {
            "parameters": {
                "operation": "getAll",
                "calendar": {
                    "__rl": true,
                    "mode": "id",
                    "value": "answer4154@gmail.com"
                },
                "timeMin": "={{ $json.timeMin }}",
                "timeMax": "={{ $json.timeMax }}",
                "options": {}
            },
            "id": "get-events",
            "name": "Get Events",
            "type": "n8n-nodes-base.googleCalendar",
            "typeVersion": 1.3,
            "position": [
                660,
                0
            ]
        },
        {
            "parameters": {
                "jsCode": "const events = $input.all();\nconst queryInfo = $('Parse Command').first().json;\nconst queryType = queryInfo.queryType;\nconst month = queryInfo.month;\nconst year = queryInfo.year;\n\n// 取得 Access Token 用於下一個節點\nconst accessToken = $('Config').first().json.accessToken;\nconst replyToken = queryInfo.replyToken;\n\nlet messageText = '';\nconst leaveKeywords = ['輪休', '超補', '休假', '公假', '換休', '補休'];\n\nif (events.length === 0 && (queryType === 'today' || queryType === 'tomorrow' || queryType === 'specificDay')) {\n  // 當天沒有任何行程，顯示上班日\n  messageText = '- **`All Day`** 上班日\\n\\n';\n} else if (queryType === 'today' || queryType === 'tomorrow' || queryType === 'specificDay') {\n  // 檢查是否有休假\n  let hasLeave = false;\n  for (const item of events) {\n    const summary = item.json.summary || '';\n    if (leaveKeywords.some(kw => summary.includes(kw))) {\n      hasLeave = true;\n      break;\n    }\n  }\n  if (!hasLeave) {\n    messageText += '- **`All Day`** 上班日\\n\\n';\n  }\n  \n  const sortedEvents = events.sort((a, b) => {\n    const timeA = a.json.start?.dateTime || a.json.start?.date || '';\n    const timeB = b.json.start?.dateTime || b.json.start?.date || '';\n    return timeA.localeCompare(timeB);\n  });\n  \n  for (const item of sortedEvents) {\n    const event = item.json;\n    const isAllDay = event.start?.date && !event.start?.dateTime;\n    \n    if (isAllDay) {\n      messageText += `- **\`All Day\`** ${event.summary || '(無標題)'}\\n\\n`;\n    } else if (event.start?.dateTime) {\n      const start = DateTime.fromISO(event.start.dateTime).setZone('Asia/Taipei');\n      const end = DateTime.fromISO(event.end.dateTime).setZone('Asia/Taipei');\n      \n      if (start.hour === 0 && start.minute === 0 && end.hour === 0 && end.minute === 0) {\n        messageText += `- **\`All Day\`** ${event.summary || '(無標題)'}\\n\\n`;\n      } else {\n        messageText += `- **\`${start.toFormat('HHmm')}-${end.toFormat('HHmm')}\`** ${event.summary || '(無標題)'}\\n\\n`;\n      }\n    }\n  }\n} else {\n  // 月份格式 - 顯示每一天\n  const startOfMonth = DateTime.fromObject({ year, month, day: 1 }, { zone: 'Asia/Taipei' });\n  const daysInMonth = startOfMonth.daysInMonth;\n  \n  const grouped = {};\n  for (const item of events) {\n    const event = item.json;\n    const startStr = event.start?.dateTime || event.start?.date;\n    const start = DateTime.fromISO(startStr).setZone('Asia/Taipei');\n    const dayKey = start.day;\n    if (!grouped[dayKey]) grouped[dayKey] = [];\n    grouped[dayKey].push(event);\n  }\n  \n  // 遍歷每一天\n  for (let day = 1; day <= daysInMonth; day++) {\n    if (grouped[day] && grouped[day].length > 0) {\n      messageText += `### ${month}/${day}\\n\\n`;\n      \n      // 檢查當天是否有休假\n      let dayHasLeave = false;\n      for (const event of grouped[day]) {\n        const summary = event.summary || '';\n        if (leaveKeywords.some(kw => summary.includes(kw))) {\n          dayHasLeave = true;\n          break;\n        }\n      }\n      if (!dayHasLeave) {\n        messageText += '- **`All Day`** 上班日\\n\\n';\n      }\n      \n      const dayEvents = grouped[day].sort((a, b) => {\n        const timeA = a.start?.dateTime || a.start?.date || '';\n        const timeB = b.start?.dateTime || b.start?.date || '';\n        return timeA.localeCompare(timeB);\n      });\n      \n      for (const event of dayEvents) {\n        const isAllDay = event.start?.date && !event.start?.dateTime;\n        \n        if (isAllDay) {\n          messageText += `- **\`All Day\`** ${event.summary || '(無標題)'}\\n\\n`;\n        } else if (event.start?.dateTime) {\n          const start = DateTime.fromISO(event.start.dateTime).setZone('Asia/Taipei');\n          const end = DateTime.fromISO(event.end.dateTime).setZone('Asia/Taipei');\n          \n          if (start.hour === 0 && start.minute === 0 && end.hour === 0 && end.minute === 0) {\n            messageText += `- **\`All Day\`** ${event.summary || '(無標題)'}\\n\\n`;\n          } else {\n            messageText += `- **\`${start.toFormat('HHmm')}-${end.toFormat('HHmm')}\`** ${event.summary || '(無標題)'}\\n\\n`;\n          }\n        }\n      }\n    } else {\n      // 當天沒有行程，顯示上班日 (依照舊邏輯)\n      messageText += `### ${month}/${day}\\n\\n- **\`All Day\`** 上班日\\n\\n`;\n    }\n  }\n}\n\n// 移除最後多餘換行\nmessageText = messageText.trim();\n\nif (messageText === '') {\n    messageText = '沒有找到相關行程。';\n}\n\nreturn [{\n  json: {\n    replyToken,\n    accessToken,\n    messages: [{\n        type: 'text',\n        text: messageText\n    }]\n  }\n}];"
            },
            "id": "format-message",
            "name": "Format Message",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                880,
                0
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://api.line.me/v2/bot/message/reply",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "Authorization",
                            "value": "=Bearer {{ $json.accessToken }}"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "replyToken",
                            "value": "={{ $json.replyToken }}"
                        },
                        {
                            "name": "messages",
                            "value": "={{ $json.messages }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "reply-to-line",
            "name": "Reply to Line",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1100,
                0
            ]
        }
    ],
    "connections": {
        "Line Webhook": {
            "main": [
                [
                    {
                        "node": "Config",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Config": {
            "main": [
                [
                    {
                        "node": "Parse Command",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Command": {
            "main": [
                [
                    {
                        "node": "Get Events",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Events": {
            "main": [
                [
                    {
                        "node": "Format Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Message": {
            "main": [
                [
                    {
                        "node": "Reply to Line",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}